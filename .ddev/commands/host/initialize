#!/bin/bash

## Description: import given test data into ddev (database and configurations)
## Usage: initialize
## Example: "ddev initialize"

HOST=https://www.in2code.de
ASSET_PATH=fileadmin/static/extensions/powermail
ASSET_VERSION=v12
ASSETS=(powermail-fileadmin.tar.gz powermail-db.gz)

if ! command -v "curl" &> /dev/null
then
    echo "COMMAND "curl" could not be found"
    echo "Please install curl for downloading necessary assets in development environment"
    exit
fi

# Create data directory
mkdir -p .project/data

for asset in "${ASSETS[@]}"
do
    echo "Downloading $asset"
    curl -s $HOST/$ASSET_PATH/$ASSET_VERSION/$asset -o .project/data/$asset
done

echo "Symlink site configuration"
cp .build/vendor/typo3/cms-install/Resources/Private/FolderStructureTemplateFiles/root-htaccess .build/public/.htaccess
mkdir -p .build/config/sites/main
ln -snf ../../../../.project/typo3/config.yaml .build/config/sites/main/config.yaml

echo "Symlink system configuration"
mkdir -p .build/config/system
ln -snf ../../../.project/typo3/settings.php .build/config/system/settings.php
ln -snf ../../../.project/typo3/additional.php .build/config/system/additional.php

echo "Import database"
mv .project/data/powermail-db.gz .project/data/powermail-db.sql.gz
ddev import-db --file=.project/data/powermail-db.sql.gz

echo "Run 'composer install'"
ddev composer install

echo "Extract fileadmin"
tar xf .project/data/powermail-fileadmin.tar.gz -C .build/public/

echo "Copy .htaccess"
cp .build/vendor/typo3/cms-install/Resources/Private/FolderStructureTemplateFiles/root-htaccess .build/public/.htaccess

echo "Update language packs (needed for behaviour tests)"
ddev typo3 language:update

ddev describe

echo "Thanks for supporting 'EXT:powermail'"
